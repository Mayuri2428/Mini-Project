<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/styles.css">
  <title>Class Insights - <%= klass.name %></title>
  <style>
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .card h3{margin-top:0}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><%= brand %></div>
    <div>
      <a href="/dashboard" style="color:#063a4b;text-decoration:none">← Dashboard</a>
      <form style="display:inline" method="post" action="/logout"><button type="submit">Logout</button></form>
    </div>
  </div>
  <div class="container">
    <h1>Insights - <%= klass.name %> <span class="muted">Section <%= klass.section || '-' %></span></h1>

    <form id="rangeForm">
      <label>From</label>
      <input type="date" name="from" value="<%= from %>">
      <label>To</label>
      <input type="date" name="to" value="<%= to %>">
      <button type="submit">Apply</button>
    </form>

    <div class="grid">
      <div class="card">
        <h3>Summary</h3>
        <canvas id="summaryChart" height="240"></canvas>
      </div>
      <div class="card">
        <h3>30-day Trend</h3>
        <canvas id="trendChart" height="240"></canvas>
      </div>
      <div class="card" style="grid-column:1/-1">
        <h3>Student Attendance %</h3>
        <canvas id="studentChart" height="320"></canvas>
      </div>
      <div class="card">
        <h3>Top Attendance (This Month)</h3>
        <ol id="topAttendance" style="margin:0;padding-left:16px"></ol>
      </div>
      <div class="card">
        <h3>Longest Streak (This Month)</h3>
        <ol id="longestStreak" style="margin:0;padding-left:16px"></ol>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const from = params.get('from') || '';
    const to = params.get('to') || '';
    const classId = Number('<%= klass.id %>');

    document.getElementById('rangeForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const q = new URLSearchParams(fd);
      location.search = q.toString();
    });

    async function fetchJSON(url){ const r = await fetch(url); return r.json(); }

    async function load() {
      const qs = `from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
      const summary = await fetchJSON(`/api/class/${classId}/summary?${qs}`);
      const trend = await fetchJSON(`/api/class/${classId}/trend?days=30`);
      const students = await fetchJSON(`/api/class/${classId}/student-percentages?${qs}`);
      const leaderboard = await fetchJSON(`/api/class/${classId}/leaderboard`);

      // Summary pie/donut
      const sctx = document.getElementById('summaryChart');
      new Chart(sctx, {
        type: 'doughnut',
        data: {
          labels: ['Present','Absent','Late','Excused'],
          datasets: [{
            data: [summary.present, summary.absent, summary.late, summary.excused],
            backgroundColor: ['#22c55e','#ef4444','#f59e0b','#60a5fa']
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom', labels: { color: '#063a4b', boxWidth: 12 } },
            tooltip: {
              backgroundColor: 'rgba(6,58,75,0.92)',
              borderColor: '#87ceeb',
              borderWidth: 1,
              titleColor: '#ffffff',
              bodyColor: '#e6f6fc'
            }
          }
        }
      });

      // Trend line
      const tctx = document.getElementById('trendChart');
      new Chart(tctx, {
        type: 'line',
        data: {
          labels: trend.map(x => x.date),
          datasets: [{ label: 'Present %', data: trend.map(x => x.rate), borderColor: '#3aa7cc', tension: .25 }]
        },
        options: {
          plugins: { legend: { labels: { color: '#063a4b' } }, tooltip: { backgroundColor: 'rgba(6,58,75,0.92)', borderColor: '#87ceeb', borderWidth: 1, titleColor: '#fff', bodyColor: '#e6f6fc' } },
          scales: {
            x: { ticks: { color: '#063a4b' }, grid: { color: 'rgba(6,58,75,0.08)' } },
            y: { suggestedMin: 0, suggestedMax: 100, ticks: { color: '#063a4b' }, grid: { color: 'rgba(6,58,75,0.08)' } }
          }
        }
      });

      // Student percentages bar
      const bctx = document.getElementById('studentChart');
      new Chart(bctx, {
        type: 'bar',
        data: {
          labels: students.map(s => (s.roll_no || '-') + ' ' + s.name),
          datasets: [{ label: 'Attendance %', data: students.map(s => s.pct), backgroundColor: '#87ceeb' }]
        },
        options: {
          indexAxis: 'x',
          scales: {
            x: { ticks: { color: '#063a4b' }, grid: { color: 'rgba(6,58,75,0.08)' } },
            y: { suggestedMin: 0, suggestedMax: 100, ticks: { color: '#063a4b' }, grid: { color: 'rgba(6,58,75,0.08)' } }
          },
          plugins: {
            legend: { display:false },
            tooltip: { backgroundColor: 'rgba(6,58,75,0.92)', borderColor: '#87ceeb', borderWidth: 1, titleColor: '#fff', bodyColor: '#e6f6fc' }
          }
        }
      });

      // Leaderboards
      const topEl = document.getElementById('topAttendance');
      topEl.innerHTML = '';
      (leaderboard.topAttendance || []).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.roll_no || '-'} ${item.name} — ${item.pct}%`;
        topEl.appendChild(li);
      });

      const streakEl = document.getElementById('longestStreak');
      streakEl.innerHTML = '';
      (leaderboard.longestStreak || []).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.roll_no || '-'} ${item.name} — ${item.streak} days`;
        streakEl.appendChild(li);
      });
    }

    load();
  </script>
</body>
</html>
