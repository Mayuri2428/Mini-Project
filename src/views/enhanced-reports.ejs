<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle %> - AttendanceMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
        }

        .filter-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            color: #495057;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .quick-filter-btn {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-filter-btn:hover, .quick-filter-btn.active {
            background: #667eea;
            color: white;
        }

        .preview-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .validation-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .validation-message.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .validation-message.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .filter-card {
                padding: 20px;
            }
            
            .quick-filters {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0,0,0,0.1);">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-graduation-cap me-2"></i>AttendanceMS
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="header-card">
            <h1><i class="fas fa-chart-bar me-3"></i>Enhanced Reports Dashboard</h1>
            <p class="mb-0">Generate comprehensive attendance reports with advanced filtering options</p>
        </div>

        <!-- Validation Messages -->
        <div id="validationMessage" class="validation-message"></div>

        <!-- Report Generation Form -->
        <div class="filter-card">
            <form id="reportForm">
                <!-- Class Selection -->
                <div class="filter-section">
                    <h4 class="section-title">
                        <i class="fas fa-chalkboard me-2"></i>Class Selection
                    </h4>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Select Class *</label>
                            <select class="form-select" name="class_id" id="classSelect" required>
                                <option value="">Choose a class...</option>
                                <% classes.forEach(cls => { %>
                                    <option value="<%= cls.id %>" 
                                            data-year="<%= cls.academic_year || '' %>"
                                            data-department="<%= cls.department || '' %>"
                                            data-subject="<%= cls.subject || '' %>"
                                            data-section="<%= cls.section || '' %>">
                                        <%= cls.name %>
                                        <% if (cls.section) { %> - Section <%= cls.section %><% } %>
                                        <% if (cls.department) { %> (<%= cls.department %>)<% } %>
                                        (<%= cls.student_count %> students)
                                    </option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Report Type *</label>
                            <select class="form-select" name="report_type" id="reportTypeSelect" required>
                                <option value="">Choose report type...</option>
                                <option value="daily_summary">Daily Summary Report</option>
                                <option value="student_wise">Student-wise Attendance</option>
                                <option value="session_wise">Session-wise Analysis</option>
                                <option value="attendance_trends">Attendance Trends</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Date Range Selection -->
                <div class="filter-section">
                    <h4 class="section-title">
                        <i class="fas fa-calendar me-2"></i>Date Range / Period
                    </h4>
                    
                    <!-- Quick Filters -->
                    <div class="quick-filters">
                        <button type="button" class="quick-filter-btn" data-range="current_week">
                            <i class="fas fa-calendar-week me-1"></i>Current Week
                        </button>
                        <button type="button" class="quick-filter-btn active" data-range="current_month">
                            <i class="fas fa-calendar-alt me-1"></i>Current Month
                        </button>
                        <button type="button" class="quick-filter-btn" data-range="current_semester">
                            <i class="fas fa-calendar me-1"></i>Current Semester
                        </button>
                        <button type="button" class="quick-filter-btn" data-range="custom">
                            <i class="fas fa-calendar-plus me-1"></i>Custom Range
                        </button>
                    </div>

                    <input type="hidden" name="date_range_type" id="dateRangeType" value="current_month">

                    <!-- Custom Date Range -->
                    <div class="row" id="customDateRange" style="display: none;">
                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" id="startDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" id="endDate">
                        </div>
                    </div>

                    <!-- Date Range Preview -->
                    <div class="preview-card">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <span id="dateRangePreview">Current Month: Loading...</span>
                        </small>
                    </div>
                </div>

                <!-- Optional Filters -->
                <div class="filter-section">
                    <h4 class="section-title">
                        <i class="fas fa-filter me-2"></i>Optional Filters
                    </h4>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Academic Year</label>
                            <select class="form-select" name="academic_year" id="academicYearFilter">
                                <option value="">All Years</option>
                                <% academicYears.forEach(year => { %>
                                    <option value="<%= year.academic_year %>"><%= year.academic_year %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department" id="departmentFilter">
                                <option value="">All Departments</option>
                                <% departments.forEach(dept => { %>
                                    <option value="<%= dept.department %>"><%= dept.department %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Subject</label>
                            <select class="form-select" name="subject" id="subjectFilter">
                                <option value="">All Subjects</option>
                                <% subjects.forEach(subj => { %>
                                    <option value="<%= subj.subject %>"><%= subj.subject %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Section</label>
                            <input type="text" class="form-control" name="section" id="sectionFilter" placeholder="e.g., A, B, C">
                        </div>
                    </div>
                </div>

                <!-- Output Format -->
                <div class="filter-section">
                    <h4 class="section-title">
                        <i class="fas fa-file-export me-2"></i>Output Format
                    </h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="formatWeb" value="web" checked>
                                <label class="form-check-label" for="formatWeb">
                                    <i class="fas fa-globe me-1"></i>View in Browser
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="formatCSV" value="csv">
                                <label class="form-check-label" for="formatCSV">
                                    <i class="fas fa-file-csv me-1"></i>Download CSV
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="formatJSON" value="json">
                                <label class="form-check-label" for="formatJSON">
                                    <i class="fas fa-code me-1"></i>JSON Data
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-chart-line me-2"></i>Generate Report
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-undo me-2"></i>Reset Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Generating Report...</h5>
            <p class="text-muted mb-0">Please wait while we process your request</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize date range preview
        document.addEventListener('DOMContentLoaded', function() {
            updateDateRangePreview();
            
            // Set default dates for current month
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = firstDay.toISOString().slice(0, 10);
            document.getElementById('endDate').value = lastDay.toISOString().slice(0, 10);
        });

        // Quick filter buttons
        document.querySelectorAll('.quick-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.quick-filter-btn').forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Set date range type
                const rangeType = this.dataset.range;
                document.getElementById('dateRangeType').value = rangeType;
                
                // Show/hide custom date range
                const customRange = document.getElementById('customDateRange');
                if (rangeType === 'custom') {
                    customRange.style.display = 'block';
                } else {
                    customRange.style.display = 'none';
                }
                
                // Update preview
                updateDateRangePreview();
            });
        });

        // Update date range preview
        function updateDateRangePreview() {
            const rangeType = document.getElementById('dateRangeType').value;
            const preview = document.getElementById('dateRangePreview');
            const today = new Date();
            
            let previewText = '';
            
            switch (rangeType) {
                case 'current_week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    previewText = `Current Week: ${formatDate(startOfWeek)} to ${formatDate(endOfWeek)}`;
                    break;
                    
                case 'current_month':
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    previewText = `Current Month: ${formatDate(firstDay)} to ${formatDate(lastDay)}`;
                    break;
                    
                case 'current_semester':
                    const month = today.getMonth();
                    let semStart, semEnd;
                    if (month >= 0 && month <= 5) {
                        semStart = new Date(today.getFullYear(), 0, 1);
                        semEnd = new Date(today.getFullYear(), 5, 30);
                        previewText = `Current Semester (Jan-Jun): ${formatDate(semStart)} to ${formatDate(semEnd)}`;
                    } else {
                        semStart = new Date(today.getFullYear(), 6, 1);
                        semEnd = new Date(today.getFullYear(), 11, 31);
                        previewText = `Current Semester (Jul-Dec): ${formatDate(semStart)} to ${formatDate(semEnd)}`;
                    }
                    break;
                    
                case 'custom':
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate && endDate) {
                        previewText = `Custom Range: ${formatDate(new Date(startDate))} to ${formatDate(new Date(endDate))}`;
                    } else {
                        previewText = 'Custom Range: Please select start and end dates';
                    }
                    break;
                    
                default:
                    previewText = 'Please select a date range';
            }
            
            preview.textContent = previewText;
        }

        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Update preview when custom dates change
        document.getElementById('startDate').addEventListener('change', updateDateRangePreview);
        document.getElementById('endDate').addEventListener('change', updateDateRangePreview);

        // Form submission
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            const classId = document.getElementById('classSelect').value;
            const reportType = document.getElementById('reportTypeSelect').value;
            
            if (!classId) {
                showValidationMessage('Please select a class', 'error');
                return;
            }
            
            if (!reportType) {
                showValidationMessage('Please select a report type', 'error');
                return;
            }
            
            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Prepare form data
            const formData = new FormData(this);
            
            // Submit form
            fetch('/reports/generate', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.headers.get('content-type')?.includes('text/csv')) {
                    // Handle CSV download
                    return response.blob().then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `report_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        showValidationMessage('Report downloaded successfully!', 'success');
                    });
                } else if (response.headers.get('content-type')?.includes('application/json')) {
                    // Handle JSON response
                    return response.json().then(data => {
                        if (formData.get('format') === 'json') {
                            // Display JSON data
                            const jsonWindow = window.open('', '_blank');
                            jsonWindow.document.write(`<pre>${JSON.stringify(data, null, 2)}</pre>`);
                        } else {
                            // Handle error
                            throw new Error(data.error || 'Unknown error');
                        }
                    });
                } else {
                    // Handle HTML response (web view)
                    return response.text().then(html => {
                        const reportWindow = window.open('', '_blank');
                        reportWindow.document.write(html);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showValidationMessage(error.message || 'Failed to generate report', 'error');
            })
            .finally(() => {
                // Hide loading
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        });

        // Show validation message
        function showValidationMessage(message, type) {
            const messageDiv = document.getElementById('validationMessage');
            messageDiv.className = `validation-message ${type}`;
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
                ${message}
            `;
            messageDiv.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Reset form
        function resetForm() {
            document.getElementById('reportForm').reset();
            document.getElementById('dateRangeType').value = 'current_month';
            document.querySelectorAll('.quick-filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-range="current_month"]').classList.add('active');
            document.getElementById('customDateRange').style.display = 'none';
            updateDateRangePreview();
            document.getElementById('validationMessage').style.display = 'none';
        }

        // Auto-populate filters based on selected class
        document.getElementById('classSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const year = selectedOption.dataset.year;
                const department = selectedOption.dataset.department;
                const subject = selectedOption.dataset.subject;
                const section = selectedOption.dataset.section;
                
                if (year) document.getElementById('academicYearFilter').value = year;
                if (department) document.getElementById('departmentFilter').value = department;
                if (subject) document.getElementById('subjectFilter').value = subject;
                if (section) document.getElementById('sectionFilter').value = section;
            }
        });
    </script>
</body>
</html>